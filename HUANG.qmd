---
title: "HUANG"
format: html
editor: visual
---

[Link to the github repository](https://github.com/clemence-code/grades-test#)


```{r}
here::i_am("grades-test.Rproj")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo    = TRUE,
  message = FALSE,
  warning = FALSE
)
```

```{r}
library(here)
library(vroom)
library(dplyr)
library(ggplot2)
library(tidyr)
library(knitr)
```

# Q1 Load data
```{r}
courses <- vroom(here("data","courses.csv"))
```


# Q2 Formatted table

```{r}
courses |>
  arrange(courses) |>
  kable(
    caption = "List of courses",
    align   = "l"
  )
```


# Q3 Load Students dataset

```{r}

students <- vroom(
  here("data", "students.csv"),
  col_types = cols(
    id         = col_integer(),
    group      = col_factor(),
    birth_date = col_date(),
    sex        = col_factor()
  )
)
```

# Q4 Load grades dataset 

```{r}
grades <- vroom(
  here("data", "grades.csv"),
  delim = ":",
  na    = "*"
)
```

# Q5 Number of students per group

```{r}
students |>
  count(group, name = "n_students") |>
  ggplot(aes(x = group, y = n_students)) +
  geom_col() +
  labs(
    title = "Number of students per group",
    x = "Group",
    y = "Number of students"
  ) +
  theme_minimal()
```

# Q6 Gender balance in each group

```{r}
students |>
  ggplot(aes(x = group, fill = sex)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Gender balance by group",
    x = "Group",
    y = "Share of students",
    fill = "Sex"
  ) +
  theme_minimal()
```

# Q7 Distribution of the age of the student
```{r}
students_age <- students |>
  mutate(
    age = as.numeric(difftime(Sys.Date(), birth_date, units = "days")) / 365.25
  )

students_age |>
  ggplot(aes(x = age)) +
  geom_histogram(binwidth = 1) +
  labs(
    title = "Distribution of students' age",
    x = "Age (years)",
    y = "Number of students"
  ) +
  theme_minimal()
```


# Q8 Median age of each student in each group
```{r}
median_age_by_group <- students_age |>
  group_by(group) |>
  summarise(
    median_age = as.integer(round(median(age, na.rm = TRUE))),
    .groups = "drop"
  )

median_age_by_group |>
  kable(
    caption = "Median age of students by group",
    col.names = c("Group", "Median age")
  )
```

# Q9 Oldest student in each group
```{r}
oldest_by_group <- students_age |>
  group_by(group) |>
  slice_max(age, n = 1, with_ties = FALSE) |>
  ungroup() |>
  arrange(desc(age)) |>
  transmute(
    id,
    sex,
    age = round(age, 1) 
  )


oldest_by_group |>
  kable(
    caption   = "Oldest student in each group",
    col.names = c("ID", "Sex", "Age")
  )
```

# Q10 Number of grades in the dataset
```{r}
nb_grades <- grades |>
  filter(!is.na(grade)) |>
  nrow()
```

The data set contains `r nb_grades` grades.


# Q11 Average of all the grades of one course

```{r}
neuro_grades_by_group <- grades |>
  inner_join(courses, by = "course_id") |>
  filter(course == "Neurotechnology and Mind Control") |>
  inner_join(students |> select(id, group), by = "id") |>
  group_by(group) |>
  summarise(
    mean_grade = mean(grade, na.rm = TRUE),
    .groups = "drop"
  )

neuro_grades_by_group |>
  ggplot(aes(x = group, y = mean_grade)) +
  geom_col() +
  labs(
    title = "Average grade in Neurotechnology and Mind Control by group",
    x = "Group",
    y = "Average grade"
  )
```


# Q12 Distribution of the grades of 2 semesters
```{r}
grades_sem <- grades |>
  inner_join(courses |> select(course_id, semester), by = "course_id") |>
  filter(!is.na(grade)) |>
  mutate(semester = as.factor(semester))

grades_sem |>
  ggplot(aes(x = grade, fill = semester)) +
  geom_density(alpha = 0.5) +
  labs(
    title = "Distribution of grades by semester",
    x = "Grade",
    y = "Density",
    fill = "Semester"
  )
```

The grades in Semester 2 where lower than the grades in Semester 1. But the grades are more homogeneous in Semester 2 than in Semester 1.

# Q13 Number of grades per students
```{r}
grades_per_student <- grades |>
  filter(!is.na(grade)) |>
  count(id, name = "n_grades")

students_grades <- students |>
  left_join(grades_per_student, by = "id") |>
  mutate(n_grades = replace_na(n_grades, 0L))

students_grades |>
  head(10) |>
  kable(
    caption = "Extract of the number of grades per student",
    col.names = c("ID", "Group", "Birth date", "Sex", "Number of grades")
  )

summary_grades <- students_grades |>
  summarise(
    min    = min(n_grades),
    max    = max(n_grades),
    mean   = mean(n_grades),
    median = median(n_grades)
  )

summary_grades |>
  kable(
    caption = "Summary of the number of grades per student",
    digits = 2,
    col.names = c("Minimum", "Maximum", "Average", "Median")
  )
```

# Q14 Distribution of the grades of male and female students
```{r}
students_grades |>
  ggplot(aes(x = n_grades)) +
  geom_histogram(binwidth = 1) +
  facet_wrap(~ sex) +
  labs(
    title = "Distribution of the number of grades by sex",
    x = "Number of grades",
    y = "Number of students"
  ) +
  theme_minimal()
```

From this graphical representation, sex doesn't seems to have any effect on the number of grades. 

# Q15 Dataframe course Astroengineering and Planetary Colonization 
```{r}
astro_grades <- grades |>
  inner_join(courses, by = "course_id") |>
  filter(course == "Astroengineering and Planetary Colonization") |>
  filter(!is.na(grade)) |>
  count(id, name = "n_grades_astro")

astro_grades_per_student <- students |>
  select(id, group) |>
  left_join(astro_grades, by = "id") |>
  mutate(n_grades_astro = replace_na(n_grades_astro, 0L))

astro_grades_per_student |>
  head(10) |>
  kable(
    caption = "Number of grades in Astroengineering and Planetary Colonization per student",
    col.names = c("ID", "Group", "Number of grades in Astroengineering")
  )
```

# Q16 Distribution of the number of grades in Astroengineering
```{r}
dist_astro_grades <- astro_grades_per_student |>
  count(n_grades_astro, name = "n_students")

dist_astro_grades |>
  kable(
    caption   = "Distribution of the number of grades in Astroengineering",
    col.names = c("Number of grades", "Number of students")
  )

dist_astro_grades |>
  ggplot(aes(x = n_grades_astro, y = n_students)) +
  geom_col() +
  labs(
    title = "Distribution of the number of grades in Astroengineering",
    x = "Number of grades",
    y = "Number of students"
  ) +
  theme_minimal()
```

# Q17 Number of grades depending on the group
```{r}
astro_grades_per_student |>
  mutate(group = as.factor(group)) |>
  ggplot(aes(x = group, y = n_grades_astro)) +
  geom_violin(trim = FALSE) +
  labs(
    title = "Distribution of Astroengineering grades per student by group",
    x = "Group",
    y = "Number of Astroengineering grades"
  ) +
  theme_minimal()
```
All groups have around 10 grades. Groups doesn't seem to have an effect on the number of astroengineering grades. 

# Q18 Dependency of the number of grades with respect to both the group and the sex of the students
```{r}
astro_group_sex <- astro_grades_per_student |>
  left_join(students |>
              select(id, sex),
            by = "id") |>
  mutate(
    group = as.factor(group),
    sex   = as.factor(sex)
  )

astro_group_sex |>
  ggplot(aes(x = group, y = n_grades_astro, fill = sex)) +
  geom_violin(trim=FALSE) +
  labs(
    title = "Number of Astroengineering grades per student by group and sex",
    x = "Group",
    y = "Number of Astroengineering grades",
    fill = "Sex"
  ) +
  theme_minimal()
```

The graphical representation show homogeneous number of Astroengineering grades accross groups and sex except in groups 5 and 2.

# Q19 Dataframe average of grades
```{r}
avg_grades_long <- grades |>
  filter(!is.na(grade)) |>
  inner_join(students |> select(id, group), by = "id") |>
  inner_join(courses |> select(course_id, course), by = "course_id") |>
  group_by(id, group, course) |>
  summarise(mean_grade = mean(grade), .groups = "drop")

avg_grades_wide <- avg_grades_long |>
  pivot_wider(
    names_from  = course,
    values_from = mean_grade
  )

avg_grades_wide |>
  select(
    id,
    group,
    `Neurotechnology and Mind Control`,
    `Astroengineering and Planetary Colonization`
  ) |>
  head(10) |>
  kable(
    caption = "Extract of average grades per student and course"
  )
```


# Q20 Average grades in Quantum Physics and Time Manipulation as a function of the average grades in Artificial Intelligence and Robotics

```{r}
avg_grades_wide |>
  ggplot(
    aes(
      x = `Artificial Intelligence and Robotics`,
      y = `Quantum Physics and Time Manipulation`
    )
  ) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE)
  labs(
    title = "Average grades: Quantum Physics vs Artificial Intelligence and Robotics",
    x = "Average grade in Artificial Intelligence and Robotics",
    y = "Average grade in Quantum Physics and Time Manipulation"
  ) +
  theme_minimal()
```

The graphical representation shows a negative correlation between the grades in Quantum physics and Artificial intelligence. But the slope is negative and close to 0. It doesn't seems to be statistically significant.
# Q21 Correlation between the average grades in Neurotechnology and the average grades in Xenobiologygroup by group

```{r}
cor_neuro_xeno_by_group <- avg_grades_wide |>
  group_by(group) |>
  summarise(
    cor_neuro_xeno = cor(
      `Neurotechnology and Mind Control`,
      `Xenobiology and Extraterrestrial Life`,
      use = "complete.obs"
    ),
    .groups = "drop"
  )

cor_neuro_xeno_by_group |>
  kable(
    caption   = "Correlation between average grades in Neurotechnology and Mind Control and Xenobiology and Extraterrestrial Life by group",
    col.names = c("Group", "Correlation")
  )
```


# Q22  Average grades in Neurotechnology as a function the average grades in Xenobiology for the students of the group in which those grades are the most correlated (positively or negatively)

```{r}
cor_neuro_xeno_by_group <- avg_grades_wide |>
  group_by(group) |>
  summarise(
    cor_neuro_xeno = cor(
      `Neurotechnology and Mind Control`,
      `Xenobiology and Extraterrestrial Life`,
      use = "complete.obs"
    ),
    .groups = "drop"
  )

target_group <- cor_neuro_xeno_by_group |>
  slice_max(abs(cor_neuro_xeno), n = 1) |>
  pull(group)

avg_grades_wide |>
  filter(group == target_group) |>
  ggplot(
    aes(
      x = `Xenobiology and Extraterrestrial Life`,
      y = `Neurotechnology and Mind Control`
    )
  ) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm")
  labs(
    title = paste(
      "Average grades in Neurotechnology vs Xenobiology for group",
      target_group
    ),
    x = "Average grade in Xenobiology and Extraterrestrial Life",
    y = "Average grade in Neurotechnology and Mind Control"
  ) +
  theme_minimal()
```


# Q23 Dataframe final grade : average of the averages of their grades

```{r}
final_grades <- avg_grades_wide |>
  left_join(students |> select(id, sex), by = "id") |>
  mutate(
    final_grade = rowMeans(
      across(-c(id, group, sex)),
      na.rm = TRUE
    )
  ) |>
  select(id, group, sex, final_grade) |>
  arrange(desc(final_grade))

final_grades |>
  head(5) |>
  kable(
    caption = "Top 5 students by final grade",
    digits = 2,
    col.names = c("ID", "Group", "Sex", "Final grade")
  )
```

# Q24 Differences in final grades between the group

```{r}
final_grades |>
  mutate(group = as.factor(group)) |>
  ggplot(aes(x = group, y = final_grade, color = group)) +
  geom_boxplot() +
  labs(
    title = "Final grades by group",
    x = "Group",
    y = "Final grade"
  ) +
  theme_minimal()
```


# Q25 Adding effect of sex

```{r}
final_grades |>
  mutate(
    group = as.factor(group),
    sex   = as.factor(sex)
  ) |>
  ggplot(aes(x = group, y = final_grade, fill = sex)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +
  labs(
    title = "Final grades by group and sex",
    x = "Group",
    y = "Final grade",
    fill = "Sex"
  ) +
  theme_minimal()
```

# Q26 Data frame pass or fail
```{r}
min_course_avg <- avg_grades_long |>
  group_by(id, group) |>
  summarise(
    min_course_avg = min(mean_grade, na.rm = TRUE),
    .groups = "drop"
  )

sem_avg <- avg_grades_long |>
  inner_join(courses |> select(course, semester), by = "course") |>
  group_by(id, group, semester) |>
  summarise(
    sem_avg = mean(mean_grade, na.rm = TRUE),
    .groups = "drop"
  ) |>
  group_by(id, group) |>
  summarise(
    all_sem_ok = all(sem_avg >= 10),
    .groups = "drop"
  )

final_base <- avg_grades_wide |>
  mutate(
    final_grade = rowMeans(across(-c(id, group)), na.rm = TRUE)
  ) |>
  select(id, group, final_grade)

pass_year <- final_base |>
  left_join(min_course_avg, by = c("id", "group")) |>
  left_join(sem_avg, by = c("id", "group")) |>
  mutate(
    pass = min_course_avg >= 5 & all_sem_ok
  ) |>
  select(id, group, final_grade, pass)

pass_year |>
  head(5) |>
  kable(
    caption = "First five rows of the pass-year data frame",
    digits = 2,
    col.names = c("ID", "Group", "Final grade", "Pass")
  )
```


# Q27 Number of students who do not pass and yet have a final grade larger or equal to 10
```{r}
n_not_pass_final <- pass_year |>
  filter(!pass, final_grade >= 10) |>
  summarise(n = n())

n_not_pass_final |>
  kable(
    caption   = "Number of students who do not pass but have a final grade â‰¥ 10",
    col.names = "Number of students"
  )
```

There are `r n_not_pass_final` student that do not pass but have a final grade greater than 10.

# Q28 Pass rate per group and graphical representation
```{r}
pass_rate_group <- pass_year |>
  group_by(group) |>
  summarise(
    pass_rate = mean(pass),
    .groups = "drop"
  )

pass_rate_group |>
  ggplot(aes(x = group, y = pass_rate,fill=group)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Pass rate by group",
    x = "Group",
    y = "Pass rate"
  ) +
  theme_minimal()
```

# Q29 Course that is the most responsible of student failure

```{r}
course_failure_counts <- avg_grades_long |>
  filter(mean_grade < 5) |>
  group_by(course) |>
  summarise(
    n_students_fail = n_distinct(id),
    .groups = "drop"
  ) |>
  arrange(desc(n_students_fail))

course_failure_counts |>
  kable(
    caption = "Number of student with an average grade < 5 by course",
    col.names = c("course","Number of failing students")
  )

course_more_failed <- course_failure_counts |>
  slice_max(n_students_fail,n=1)
```

The course that is the most responsible of student failure owing to grades below than 5 is `{r} course_more_failed`.

# Q30 Effect of age on success

We use students_age that we have already computed in Q7.

```{r}
pass_age <- pass_year |>
  inner_join(students_age |> select(id, age), by = "id") |>
  mutate(age = floor(age))

success_by_age <- pass_age |>
  group_by(age) |>
  summarise(
    success_rate = mean(pass),
    n_students   = n(),
    .groups = "drop"
  )

success_by_age |>
  ggplot(aes(x = age, y = success_rate)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Success rate as a function of age",
    x = "Age (years)",
    y = "Success rate"
  ) +
  theme_minimal()
```

